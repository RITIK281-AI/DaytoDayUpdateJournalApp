@page "/add"
@page "/add/{Date:datetime}"
@page "/edit/{Id:int}"
@using JournalApp.Models
@using JournalApp.Services
@using System.Security.Cryptography
@using System.Text
@inject DatabaseService DbService
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime

@if (showPinPrompt)
{
    <div class="pin-overlay">
        <div class="pin-dialog">
            <h3>Journal Entry Locked</h3>
            <p>Enter your PIN to unlock this journal entry</p>
            <div class="pin-input-container">
                <input type="password" @bind="enteredPin" class="pin-input" placeholder="Enter PIN" />
            </div>
            @if (!string.IsNullOrEmpty(pinError))
            {
                <div class="pin-error">@pinError</div>
            }
            <div class="pin-buttons">
                <button class="btn btn-secondary" @onclick="CancelPin">Cancel</button>
                <button class="btn btn-primary" @onclick="VerifyPin">Unlock</button>
            </div>
        </div>
    </div>
}

<div class="editor-container @(showPinPrompt ? "blurred" : "") ">
    <!-- Editor Header -->
    <div class="editor-header">
        <div class="header-left">
            <button class="back-btn" @onclick="Cancel">
                <span class="back-icon">←</span>
                <span class="back-text">Back</span>
            </button>
        </div>
        <div class="header-center">
            <h2 class="editor-title">@(Id == 0 ? "New Entry" : "Edit Entry")</h2>
            <p class="editor-date">@entryModel.Date.ToString("dddd, MMMM dd, yyyy")</p>
            @if (entryModel.Date.Date != DateTime.Today)
            {
                <div class="read-only-badge">Read Only</div>
            }
        </div>
        <div class="header-right">
            @if (entryModel.Date.Date == DateTime.Today || !entryModel.IsLocked || isUnlocked)
            {
                <button class="save-btn" @onclick="SaveEntry" disabled="@(!isEditingAllowed)">
                    <span class="save-icon">💾</span>
                    <span class="save-text">Save</span>
                </button>
            }
        </div>
    </div>

    <!-- Main Editor Form -->
    <div class="editor-form">
        <EditForm Model="@entryModel" OnValidSubmit="@SaveEntry">
            <DataAnnotationsValidator />

            @if (entryModel.Date.Date != DateTime.Today && !isUnlocked)
            {
                <div class="read-only-message">
                    <p>Past journal entries are view only and cannot be edited or deleted.</p>
                </div>
            }

            <!-- Title Section -->
            <div class="form-section">
                <label class="form-label">Title</label>
                <InputText class="title-input" @bind-Value="entryModel.Title" 
                          placeholder="What's on your mind today?" 
                          disabled="@(!isEditingAllowed)" />
            </div>

            <!-- Mood Section -->
            <div class="form-section">
                <label class="form-label">How are you feeling?</label>
                <div class="mood-instruction">
                    <small>Select one primary mood and up to two optional secondary moods</small>
                </div>
                
                <div class="mood-selected">
                    <div class="selected-mood primary">
                        <span>Primary: </span>
                        @if (!string.IsNullOrEmpty(entryModel.PrimaryMood))
                        {
                            <span class="mood-tag">
                                @GetMoodEmoji(entryModel.PrimaryMood) @entryModel.PrimaryMood
                            </span>
                        }
                        else
                        {
                            <span class="mood-tag empty">Not selected</span>
                        }
                    </div>
                    <div class="selected-mood secondary">
                        <span>Secondary: </span>
                        @if (entryModel.GetSecondaryMoodsList().Any())
                        {
                            foreach (var mood in entryModel.GetSecondaryMoodsList())
                            {
                                <span class="mood-tag">
                                    @GetMoodEmoji(mood) @mood
                                    <span class="remove-mood" @onclick="() => entryModel.ToggleSecondaryMood(mood)">×</span>
                                </span>
                            }
                        }
                        else
                        {
                            <span class="mood-tag empty">None selected</span>
                        }
                    </div>
                </div>

                <div class="mood-selector">
                    @foreach (var mood in GetMoodOptions())
                    {
                        <div class="mood-option 
                            @(entryModel.PrimaryMood == mood.Value ? "primary-selected" : "") 
                            @(entryModel.HasSecondaryMood(mood.Value) ? "secondary-selected" : "") "
                             @onclick="() => OnMoodSelected(mood.Value)"
                             title="@mood.Value">
                            <span class="mood-emoji">@mood.Emoji</span>
                            <span class="mood-name">@mood.Value</span>
                        </div>
                    }
                </div>
            </div>

            <!-- Tags Section -->
            <div class="form-section">
                <label class="form-label">Tags</label>
                <div class="tags-container">
                    <InputText class="tags-input" @bind-Value="entryModel.Tags" placeholder="work, personal, health..." />
                    <div class="tags-suggestions">
                        <span class="suggestion-label">Suggestions:</span>
                        @foreach (var tag in GetCommonTags())
                        {
                            <span class="tag-suggestion" @onclick="() => AddTag(tag)">#@tag</span>
                        }
                    </div>
                </div>
            </div>

            <!-- Content Section -->
            <div class="form-section content-section">
                <label class="form-label">Your thoughts</label>
                <div class="content-wrapper">
                    <InputTextArea class="content-input" @bind-Value="entryModel.Content" 
                                   placeholder="Start writing here... Express yourself freely..." rows="12" />
                    <div class="content-footer">
                        <span class="char-count">@entryModel.Content.Length characters</span>
                        <span class="writing-tip">💡 Take your time, there's no rush</span>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button type="button" class="action-btn secondary" @onclick="Cancel">
                    Cancel
                </button>
                <button type="submit" class="action-btn primary">
                    <span class="btn-icon">✨</span>
                    Save Entry
                </button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }
    [Parameter] public DateTime? Date { get; set; }
    private JournalEntry entryModel = new JournalEntry { Date = DateTime.Today };
    private bool showPinPrompt = false;
    private string enteredPin = string.Empty;
    private string pinError = string.Empty;
    private bool isUnlocked = false;
    private bool isEditingAllowed => (entryModel.Date.Date == DateTime.Today || isUnlocked) && !entryModel.IsLocked;

    private class MoodOption
    {
        public string Value { get; set; } = string.Empty;
        public string Emoji { get; set; } = string.Empty;

        public MoodOption(string value, string emoji)
        {
            Value = value;
            Emoji = emoji;
        }
    }

    private List<MoodOption> GetMoodOptions()
    {
        return new List<MoodOption>
        {
            new("Happy", "😊"),
            new("Excited", "🤩"),
            new("Grateful", "🙏"),
            new("Neutral", "😐"),
            new("Sad", "😢"),
            new("Stressed", "😫"),
            new("Anxious", "😰"),
            new("Angry", "😠"),
            new("Tired", "😴")
        };
    }

    private string GetMoodEmoji(string mood) =>
        GetMoodOptions().FirstOrDefault(m => m.Value.Equals(mood, StringComparison.OrdinalIgnoreCase))?.Emoji ?? "❓";

    private void OnMoodSelected(string mood)
    {
        if (!isEditingAllowed) return;
        
        // If clicking on primary mood, toggle it off
        if (entryModel.PrimaryMood == mood)
        {
            entryModel.PrimaryMood = string.Empty;
        }
        // If clicking on a secondary mood, toggle it
        else if (entryModel.HasSecondaryMood(mood))
        {
            entryModel.ToggleSecondaryMood(mood);
        }
        // If no primary mood is selected, set it
        else if (string.IsNullOrEmpty(entryModel.PrimaryMood))
        {
            // If this mood was a secondary, remove it first
            if (entryModel.HasSecondaryMood(mood))
                entryModel.ToggleSecondaryMood(mood);
            entryModel.PrimaryMood = mood;
        }
        // Otherwise, add as secondary if we have less than 2
        else if (entryModel.GetSecondaryMoodsList().Count < 2)
        {
            // If this was the primary, clear it first
            if (entryModel.PrimaryMood == mood)
                entryModel.PrimaryMood = string.Empty;
            entryModel.ToggleSecondaryMood(mood);
        }
    }

    private async Task SaveEntry()
    {
        if (!isEditingAllowed) return;

        // For new entries or when editing today's entry, set PIN if not set
        if (entryModel.Date.Date == DateTime.Today && string.IsNullOrEmpty(entryModel.PinHash))
        {
            var pin = await JSRuntime.InvokeAsync<string>("prompt", "Set a 4-digit PIN to secure this entry:");
            if (string.IsNullOrEmpty(pin) || pin.Length != 4 || !int.TryParse(pin, out _))
            {
                await JSRuntime.InvokeVoidAsync("alert", "Please enter a valid 4-digit PIN.");
                return;
            }
            entryModel.PinHash = HashPin(pin);
            entryModel.IsLocked = true;
        }

        entryModel.UpdatedAt = DateTime.Now;
        
        if (entryModel.Id == 0)
        {
            entryModel.CreatedAt = DateTime.Now;
            await DbService.SaveJournalEntryAsync(entryModel);
        }
        else
        {
            await DbService.UpdateJournalEntryAsync(entryModel);
        }

        NavManager.NavigateTo($"entry/{entryModel.Date:yyyy-MM-dd}");
    }

    private string HashPin(string pin)
    {
        using var sha256 = SHA256.Create();
        var hashedBytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(pin));
        return Convert.ToBase64String(hashedBytes);
    }

    private async Task VerifyPin()
    {
        if (string.IsNullOrEmpty(enteredPin) || enteredPin.Length != 4 || !int.TryParse(enteredPin, out _))
        {
            pinError = "Please enter a valid 4-digit PIN.";
            return;
        }

        var hashedPin = HashPin(enteredPin);
        if (hashedPin == entryModel.PinHash)
        {
            isUnlocked = true;
            showPinPrompt = false;
            pinError = string.Empty;
            enteredPin = string.Empty;
            StateHasChanged();
        }
        else
        {
            pinError = "Incorrect PIN. Please try again.";
            enteredPin = string.Empty;
        }
    }

    private void CancelPin()
    {
        showPinPrompt = false;
        enteredPin = string.Empty;
        pinError = string.Empty;
        NavManager.NavigateTo("/");
    }

    private void Cancel()
    {
        if (entryModel.Id == 0 || entryModel.Date.Date == DateTime.Today)
            NavManager.NavigateTo("/");
        else
            NavManager.NavigateTo($"entry/{entryModel.Date:yyyy-MM-dd}");
    }

    protected override async Task OnInitializedAsync()
    {
        if (Id > 0)
        {
            entryModel = await DbService.GetJournalEntryAsync(Id);
        }
        else if (Date.HasValue)
        {
            var existingEntry = await DbService.GetJournalEntryByDateAsync(Date.Value);
            if (existingEntry != null)
            {
                entryModel = existingEntry;
            }
            else
            {
                entryModel = new JournalEntry { Date = Date.Value };
            }
        }

        // Show PIN prompt if entry is locked and it's not today's entry
        if (entryModel.IsLocked && entryModel.Date.Date != DateTime.Today)
        {
            showPinPrompt = true;
        }
    }

    private void AddTag(string tag)
    {
        if (string.IsNullOrEmpty(entryModel.Tags))
        {
            entryModel.Tags = tag;
        }
        else if (!entryModel.Tags.Split(',').Any(t => t.Trim().Equals(tag, StringComparison.OrdinalIgnoreCase)))
        {
            entryModel.Tags += $", {tag}";
        }
    }

    private List<string> GetCommonTags()
    {
        return new List<string> { "work", "personal", "health", "family", "friends", "travel", "learning", "gratitude" };
    }
}

<style>
    /* PIN Dialog */
    .pin-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .pin-dialog {
        background: var(--bg-color);
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 400px;
        text-align: center;
    }

    .pin-input-container {
        margin: 1.5rem 0;
    }

    .pin-input {
        width: 100%;
        padding: 0.75rem;
        font-size: 1.2rem;
        text-align: center;
        border: 2px solid var(--border-color);
        border-radius: 4px;
        background: var(--input-bg);
        color: var(--text-color);
    }

    .pin-buttons {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .pin-error {
        color: #ff4444;
        margin-top: 0.5rem;
        min-height: 1.5rem;
    }

    /* Editor Container */
    .editor-container {
        max-width: 800px;
        margin: 0 auto;
        transition: filter 0.3s ease;
    }

    .blurred {
        filter: blur(5px);
        pointer-events: none;
        user-select: none;
    }
        padding: 2rem;
        background: var(--card-bg);
        min-height: 100vh;
    }

    /* Editor Header */
    .editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 2rem;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 2rem;
    }

    .header-left, .header-right {
        flex-shrink: 0;
    }

    .header-center {
        flex: 1;
        text-align: center;
    }

    .back-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: none;
        border: 1px solid var(--border-color);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        color: var(--text-color);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .back-btn:hover {
        background: var(--card-bg);
        transform: translateX(-2px);
    }

    .back-icon {
        font-size: 1.2rem;
    }

    .back-text {
        font-weight: 500;
    }

    .editor-title {
        font-size: 1.8rem;
        font-weight: 600;
        color: var(--text-color);
        margin: 0;
    }

    .editor-date {
        color: var(--muted-text);
        margin: 0.5rem 0 0 0;
        font-size: 0.95rem;
    }

    .save-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .save-btn:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
    }

    /* Form Sections */
    .form-section {
        margin-bottom: 2rem;
    }

    .form-label {
        display: block;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.75rem;
    }

    /* Title Input */
    .title-input {
        width: 100%;
        padding: 1rem;
        font-size: 1.3rem;
        font-weight: 600;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        background: var(--card-bg);
        color: var(--text-color);
        transition: all 0.2s ease;
    }

    .title-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(var(--primary-color), 0.1);
    }

    /* Mood Selector */
    .mood-selector {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .mood-instruction {
        color: var(--text-muted);
        margin-bottom: 1rem;
        font-size: 0.9rem;
    }

    .mood-selected {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: var(--card-bg);
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .selected-mood {
        margin-bottom: 0.5rem;
    }

    .selected-mood:last-child {
        margin-bottom: 0;
    }

    .mood-tag {
        display: inline-flex;
        align-items: center;
        background: var(--tag-bg);
        padding: 0.35rem 0.8rem;
        border-radius: 20px;
        margin: 0.25rem;
        font-size: 0.9rem;
    }

    .mood-tag.empty {
        opacity: 0.7;
        font-style: italic;
    }

    .remove-mood {
        margin-left: 0.5rem;
        cursor: pointer;
        font-size: 1.2rem;
        line-height: 1;
        opacity: 0.7;
    }

    .remove-mood:hover {
        opacity: 1;
    }

    .mood-option {
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.2s;
        text-align: center;
        min-height: 80px;
        background: var(--card-bg);
    }

    .mood-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .mood-emoji {
        font-size: 1.5rem;
    }

    .mood-name {
        font-weight: 500;
        color: var(--text-color);
        font-size: 0.9rem;
    }

    /* Tags Section */
    .tags-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .tags-input {
        width: 100%;
        padding: 1rem;
        font-size: 1rem;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        background: var(--card-bg);
        color: var(--text-color);
        transition: all 0.2s ease;
    }

    .tags-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(var(--primary-color), 0.1);
    }

    .tags-suggestions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
    }

    .suggestion-label {
        color: var(--muted-text);
        font-size: 0.9rem;
        margin-right: 0.5rem;
    }

    .tag-suggestion {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        color: var(--text-color);
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .tag-suggestion:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    /* Content Section */
    .content-section {
        margin-bottom: 2rem;
    }

    .content-wrapper {
        position: relative;
    }

    .content-input {
        width: 100%;
        padding: 1.5rem;
        font-size: 1.1rem;
        line-height: 1.6;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        background: var(--card-bg);
        color: var(--text-color);
        resize: vertical;
        min-height: 300px;
        font-family: inherit;
        transition: all 0.2s ease;
    }

    .content-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(var(--primary-color), 0.1);
    }

    .content-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
        padding: 0.5rem 1rem;
        background: rgba(var(--primary-color), 0.05);
        border-radius: 8px;
    }

    .char-count {
        font-size: 0.85rem;
        color: var(--muted-text);
    }

    .writing-tip {
        font-size: 0.85rem;
        color: var(--primary-color);
        font-style: italic;
    }

    /* Form Actions */
    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        padding-top: 2rem;
        border-top: 1px solid var(--border-color);
    }

    .action-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .action-btn.primary {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .action-btn.primary:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
    }

    .action-btn.secondary {
        background: var(--card-bg);
        color: var(--text-color);
        border-color: var(--border-color);
    }

    .action-btn.secondary:hover {
        background: var(--border-color);
    }

    .btn-icon {
        font-size: 1rem;
    }

    /* Dark Mode Enhancements */
    .dark-mode .mood-option.selected {
        background: rgba(74, 158, 255, 0.2);
    }

    .dark-mode .content-footer {
        background: rgba(74, 158, 255, 0.1);
    }

    .dark-mode .tag-suggestion:hover {
        background: var(--primary-color);
        color: white;
    }
</style>
