using JournalApp.Models;
using System.Text;
using System.IO;

namespace JournalApp.Services
{
    public class PdfService
    {
        public async Task<byte[]> GenerateEntryPdfAsync(JournalEntry entry)
        {
            var content = GenerateEntryText(entry);
            return Encoding.UTF8.GetBytes(content);
        }

        public async Task<byte[]> GenerateMonthPdfAsync(List<JournalEntry> entries, DateTime month)
        {
            var content = GenerateMonthText(entries, month);
            return Encoding.UTF8.GetBytes(content);
        }

        public async Task<byte[]> GenerateTimelineExportAsync(List<JournalEntry> entries, string startDate, string endDate)
        {
            var content = GenerateTimelineText(entries, startDate, endDate);
            return Encoding.UTF8.GetBytes(content);
        }

        private string GenerateEntryText(JournalEntry entry)
        {
            var wordCount = entry.Content.Split(' ').Length;
            var readingTime = Math.Max(1, (int)Math.Ceiling(wordCount / 200.0));
            
            var content = new StringBuilder();
            content.AppendLine(new string('=', 60));
            content.AppendLine($"JOURNAL ENTRY - {entry.Date:MMMM dd, yyyy}");
            content.AppendLine(new string('=', 60));
            content.AppendLine();
            content.AppendLine($"Date: {entry.Date:dddd, MMMM dd, yyyy}");
            content.AppendLine($"Title: {entry.Title}");
            content.AppendLine($"Mood: {entry.PrimaryMood}");
            content.AppendLine();
            content.AppendLine("Statistics:");
            content.AppendLine($"  Words: {wordCount}");
            content.AppendLine($"  Characters: {entry.Content.Length}");
            content.AppendLine($"  Reading Time: ~{readingTime} min");
            content.AppendLine();
            content.AppendLine("Content:");
            content.AppendLine(entry.Content);
            content.AppendLine();
            
            if (!string.IsNullOrEmpty(entry.Tags))
            {
                content.AppendLine("Tags:");
                foreach (var tag in entry.Tags.Split(',').Select(t => t.Trim()).Where(t => !string.IsNullOrEmpty(t)))
                {
                    content.AppendLine($"  #{tag}");
                }
                content.AppendLine();
            }
            
            content.AppendLine("Metadata:");
            content.AppendLine($"  Created: {entry.CreatedAt:MMMM dd, yyyy at h:mm tt}");
            if (entry.UpdatedAt > entry.CreatedAt)
            {
                content.AppendLine($"  Updated: {entry.UpdatedAt:MMMM dd, yyyy at h:mm tt}");
            }
            content.AppendLine($"  Generated: {DateTime.Now:MMMM dd, yyyy at h:mm tt}");
            content.AppendLine("  Personal Journal App");
            content.AppendLine(new string('=', 60));
            
            return content.ToString();
        }

        private string GenerateMonthText(List<JournalEntry> entries, DateTime month)
        {
            var content = new StringBuilder();
            content.AppendLine(new string('=', 60));
            content.AppendLine($"JOURNAL ENTRIES - {month:MMMM yyyy}");
            content.AppendLine(new string('=', 60));
            content.AppendLine();
            
            // Monthly Summary
            content.AppendLine("MONTHLY SUMMARY:");
            content.AppendLine($"  Total Entries: {entries.Count}");
            if (entries.Any())
            {
                var topMood = entries.GroupBy(e => e.PrimaryMood).OrderByDescending(g => g.Count()).First().Key;
                var avgWords = Math.Round(entries.Average(e => e.Content.Split(' ').Length));
                content.AppendLine($"  Most Common Mood: {topMood}");
                content.AppendLine($"  Average Words: {avgWords}");
            }
            content.AppendLine();
            content.AppendLine(new string('-', 60));
            content.AppendLine();
            
            // Add entries
            foreach (var entry in entries.OrderBy(e => e.Date))
            {
                content.AppendLine($"{entry.Date:dddd, MMMM dd, yyyy}");
                content.AppendLine($"{entry.Title}");
                content.AppendLine($"Mood: {entry.PrimaryMood}");
                content.AppendLine();
                content.AppendLine(entry.Content);
                content.AppendLine();
                
                if (!string.IsNullOrEmpty(entry.Tags))
                {
                    content.AppendLine($"Tags: {entry.Tags}");
                    content.AppendLine();
                }
                content.AppendLine(new string('-', 40));
                content.AppendLine();
            }
            
            content.AppendLine(new string('=', 60));
            content.AppendLine($"Generated on {DateTime.Now:MMMM dd, yyyy at h:mm tt}");
            content.AppendLine($"Personal Journal App");
            content.AppendLine($"Contains {entries.Count} journal entries for {month:MMMM yyyy}");
            content.AppendLine(new string('=', 60));
            
            return content.ToString();
        }

        private string GenerateTimelineText(List<JournalEntry> entries, string startDate, string endDate)
        {
            var content = new StringBuilder();
            content.AppendLine(new string('=', 70));
            content.AppendLine($"JOURNAL EXPORT - {startDate} to {endDate}");
            content.AppendLine(new string('=', 70));
            content.AppendLine();
            
            // Export Summary
            content.AppendLine("EXPORT SUMMARY:");
            content.AppendLine($"  Date Range: {startDate} to {endDate}");
            content.AppendLine($"  Total Entries: {entries.Count}");
            content.AppendLine($"  Total Words: {entries.Sum(e => e.Content.Split(' ').Length)}");
            
            if (entries.Any())
            {
                var topMood = entries.GroupBy(e => e.PrimaryMood).OrderByDescending(g => g.Count()).First().Key;
                var avgWords = Math.Round(entries.Average(e => e.Content.Split(' ').Length));
                content.AppendLine($"  Most Common Mood: {topMood}");
                content.AppendLine($"  Average Words per Entry: {avgWords}");
            }
            
            content.AppendLine();
            content.AppendLine(new string('-', 70));
            content.AppendLine();
            
            // Add all entries in chronological order
            foreach (var entry in entries.OrderBy(e => e.Date))
            {
                content.AppendLine($"{entry.Date:dddd, MMMM dd, yyyy}");
                content.AppendLine($"Title: {entry.Title}");
                content.AppendLine($"Mood: {entry.PrimaryMood}");
                
                if (!string.IsNullOrEmpty(entry.SecondaryMoods))
                {
                    content.AppendLine($"Secondary Moods: {entry.SecondaryMoods}");
                }
                
                var wordCount = entry.Content.Split(' ').Length;
                content.AppendLine($"Word Count: {wordCount}");
                content.AppendLine();
                content.AppendLine("Content:");
                content.AppendLine(entry.Content);
                content.AppendLine();
                
                if (!string.IsNullOrEmpty(entry.Tags))
                {
                    content.AppendLine("Tags:");
                    foreach (var tag in entry.Tags.Split(',').Select(t => t.Trim()).Where(t => !string.IsNullOrEmpty(t)))
                    {
                        content.AppendLine($"  #{tag}");
                    }
                    content.AppendLine();
                }
                
                content.AppendLine($"Created: {entry.CreatedAt:MMMM dd, yyyy at h:mm tt}");
                if (entry.UpdatedAt > entry.CreatedAt)
                {
                    content.AppendLine($"Updated: {entry.UpdatedAt:MMMM dd, yyyy at h:mm tt}");
                }
                
                content.AppendLine(new string('-', 70));
                content.AppendLine();
            }
            
            content.AppendLine(new string('=', 70));
            content.AppendLine($"Export Generated: {DateTime.Now:MMMM dd, yyyy at h:mm tt}");
            content.AppendLine($"Total Entries Exported: {entries.Count}");
            content.AppendLine($"Personal Journal App");
            content.AppendLine(new string('=', 70));
            
            return content.ToString();
        }
    }
}