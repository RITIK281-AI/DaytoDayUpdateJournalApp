@page "/dashboard"
@using JournalApp.Models
@using JournalApp.Services
@inject DatabaseService DbService
@inject NavigationManager NavManager
@inject PdfService PdfService

<div class="container mt-4 mb-5">
    <!-- Page Header -->
    <div class="dashboard-header mb-5">
        <h1 class="dashboard-title">Dashboard</h1>
        <p class="dashboard-subtitle">Your journal insights at a glance</p>
    </div>

    @if (dashboardData == null)
    {
        <div class="text-center mt-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Loading insights...</p>
        </div>
    }
    else
    {
        <!-- Key Metrics Row -->
        <div class="row mb-4">
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="metric-card">
                    <div class="metric-icon">📝</div>
                    <div class="metric-content">
                        <div class="metric-value">@dashboardData.TotalEntries</div>
                        <div class="metric-label">Total Entries</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="metric-card">
                    <div class="metric-icon">🔥</div>
                    <div class="metric-content">
                        <div class="metric-value">@dashboardData.CurrentStreak</div>
                        <div class="metric-label">Day Streak</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="metric-card">
                    <div class="metric-icon">😊</div>
                    <div class="metric-content">
                        <div class="metric-value">@dashboardData.MostCommonMood</div>
                        <div class="metric-label">Most Common Mood</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="metric-card">
                    <div class="metric-icon">📅</div>
                    <div class="metric-content">
                        <div class="metric-value">@dashboardData.DaysThisMonth</div>
                        <div class="metric-label">Days This Month</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mood Distribution -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="insight-card">
                    <h3 class="insight-title">Mood Distribution</h3>
                    <div class="mood-grid">
                        @foreach (var mood in dashboardData.MoodDistribution)
                        {
                            <div class="mood-item">
                                <div class="mood-emoji">@GetMoodEmoji(mood.Mood)</div>
                                <div class="mood-info">
                                    <div class="mood-name">@mood.Mood</div>
                                    <div class="mood-count">@mood.Count entries</div>
                                </div>
                                <div class="mood-percentage">@mood.Percentage%</div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="col-lg-6 mb-4">
                <div class="insight-card">
                    <h3 class="insight-title">Recent Activity</h3>
                    <div class="activity-list">
                        @foreach (var entry in dashboardData.RecentEntries.Take(5))
                        {
                            <div class="activity-item">
                                <div class="activity-date">@entry.Date.ToString("MMM dd")</div>
                                <div class="activity-mood">@GetMoodEmoji(entry.PrimaryMood)</div>
                                <div class="activity-title">@entry.Title</div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Writing Patterns -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="insight-card">
                    <h3 class="insight-title">Monthly Writing Pattern</h3>
                    <div class="pattern-grid">
                        @foreach (var month in dashboardData.MonthlyData)
                        {
                            <div class="pattern-item">
                                <div class="pattern-month">@month.Month</div>
                                <div class="pattern-bar">
                                    <div class="pattern-fill" style="width: @(month.Percentage)%"></div>
                                </div>
                                <div class="pattern-count">@month.Entries</div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row">
            <div class="col-12">
                <div class="insight-card">
                    <h3 class="insight-title">Quick Actions</h3>
                    <div class="action-buttons">
                        <button class="action-btn primary" @onclick="GoToAdd">
                            <span class="action-icon">✏️</span>
                            <span class="action-text">Write New Entry</span>
                        </button>
                        <button class="action-btn secondary" @onclick="GoToHome">
                            <span class="action-icon">📚</span>
                            <span class="action-text">View All Entries</span>
                        </button>
                        <button class="action-btn secondary" @onclick="ExportData">
                            <span class="action-icon">📤</span>
                            <span class="action-text">Export Journal</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private DashboardData? dashboardData;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        var entries = await DbService.GetEntriesAsync();
        
        dashboardData = new DashboardData
        {
            TotalEntries = entries.Count,
            CurrentStreak = CalculateCurrentStreak(entries),
            MostCommonMood = GetMostCommonMood(entries),
            DaysThisMonth = entries.Count(e => e.Date.Month == DateTime.Now.Month && e.Date.Year == DateTime.Now.Year),
            MoodDistribution = GetMoodDistribution(entries),
            RecentEntries = entries.OrderByDescending(e => e.Date).ToList(),
            MonthlyData = GetMonthlyData(entries)
        };
    }

    private int CalculateCurrentStreak(List<JournalEntry> entries)
    {
        if (!entries.Any()) return 0;
        
        var sortedEntries = entries.OrderByDescending(e => e.Date).ToList();
        var streak = 0;
        var currentDate = DateTime.Today;
        
        foreach (var entry in sortedEntries)
        {
            if (entry.Date.Date == currentDate.Date)
            {
                streak++;
                currentDate = currentDate.AddDays(-1);
            }
            else if (entry.Date.Date < currentDate.Date)
            {
                break;
            }
        }
        
        return streak;
    }

    private string GetMostCommonMood(List<JournalEntry> entries)
    {
        if (!entries.Any()) return "None";
        
        return entries
            .GroupBy(e => e.PrimaryMood)
            .OrderByDescending(g => g.Count())
            .First()
            .Key;
    }

    private List<MoodData> GetMoodDistribution(List<JournalEntry> entries)
    {
        if (!entries.Any()) return new List<MoodData>();
        
        var moodGroups = entries
            .GroupBy(e => e.PrimaryMood)
            .Select(g => new MoodData
            {
                Mood = g.Key,
                Count = g.Count(),
                Percentage = Math.Round((double)g.Count() / entries.Count * 100, 1)
            })
            .OrderByDescending(m => m.Count)
            .ToList();
            
        return moodGroups;
    }

    private List<MonthlyData> GetMonthlyData(List<JournalEntry> entries)
    {
        var monthlyData = new List<MonthlyData>();
        var maxEntries = 0;
        
        // Get last 6 months
        for (int i = 5; i >= 0; i--)
        {
            var month = DateTime.Now.AddMonths(-i);
            var monthEntries = entries.Where(e => e.Date.Month == month.Month && e.Date.Year == month.Year).ToList();
            
            monthlyData.Add(new MonthlyData
            {
                Month = month.ToString("MMM"),
                Entries = monthEntries.Count
            });
            
            maxEntries = Math.Max(maxEntries, monthEntries.Count);
        }
        
        // Calculate percentages
        foreach (var month in monthlyData)
        {
            month.Percentage = maxEntries > 0 ? (double)month.Entries / maxEntries * 100 : 0;
        }
        
        return monthlyData;
    }

    private string GetMoodEmoji(string mood) => mood switch
    {
        "Happy" => "😊",
        "Excited" => "🤩",
        "Sad" => "😢",
        "Stressed" => "😫",
        "Grateful" => "🙏",
        "Neutral" => "😐",
        _ => "😐"
    };

    private void GoToAdd() => NavManager.NavigateTo("/add");
    private void GoToHome() => NavManager.NavigateTo("/");
    private async Task ExportData()
    {
        try
        {
            var entries = await DbService.GetEntriesAsync();
            
            if (!entries.Any())
            {
                await Application.Current.MainPage.DisplayAlert(
                    "No Entries", 
                    "There are no journal entries to export.", 
                    "OK"
                );
                return;
            }

            var exportBytes = await PdfService.GenerateMonthPdfAsync(entries, DateTime.Now);
            var fileName = $"Journal_Complete_{DateTime.Now:yyyy-MM-dd}.txt";
            
            await SaveExportFile(exportBytes, fileName);
        }
        catch (Exception ex)
        {
            await Application.Current.MainPage.DisplayAlert(
                "Export Failed", 
                $"Could not export journal entries: {ex.Message}", 
                "OK"
            );
        }
    }

    private async Task SaveExportFile(byte[] fileBytes, string fileName)
    {
        try
        {
            var downloadsPath = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.UserProfile), "Downloads");
            var filePath = Path.Combine(downloadsPath, fileName);
            
            await File.WriteAllBytesAsync(filePath, fileBytes);
            
            await Application.Current.MainPage.DisplayAlert(
                "Export Successful", 
                $"Journal exported successfully!\n\nFile saved to:\n{filePath}", 
                "OK"
            );
        }
        catch (Exception ex)
        {
            await Application.Current.MainPage.DisplayAlert(
                "Export Failed", 
                $"Could not save the file: {ex.Message}", 
                "OK"
            );
        }
    }

    // Data models
    public class DashboardData
    {
        public int TotalEntries { get; set; }
        public int CurrentStreak { get; set; }
        public string MostCommonMood { get; set; } = string.Empty;
        public int DaysThisMonth { get; set; }
        public List<MoodData> MoodDistribution { get; set; } = new();
        public List<JournalEntry> RecentEntries { get; set; } = new();
        public List<MonthlyData> MonthlyData { get; set; } = new();
    }

    public class MoodData
    {
        public string Mood { get; set; } = string.Empty;
        public int Count { get; set; }
        public double Percentage { get; set; }
    }

    public class MonthlyData
    {
        public string Month { get; set; } = string.Empty;
        public int Entries { get; set; }
        public double Percentage { get; set; }
    }
}

<style>
    /* Dashboard Header */
    .dashboard-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .dashboard-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-color);
        margin-bottom: 0.5rem;
    }

    .dashboard-subtitle {
        font-size: 1.1rem;
        color: var(--muted-text);
        margin-bottom: 0;
    }

    /* Metric Cards */
    .metric-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.3s ease;
        height: 100%;
    }

    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px var(--shadow-color);
    }

    .metric-icon {
        font-size: 2rem;
        width: 3rem;
        height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--primary-color);
        border-radius: 50%;
        flex-shrink: 0;
    }

    .metric-content {
        flex: 1;
    }

    .metric-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--text-color);
        line-height: 1;
    }

    .metric-label {
        font-size: 0.9rem;
        color: var(--muted-text);
        margin-top: 0.25rem;
    }

    /* Insight Cards */
    .insight-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 1.5rem;
        height: 100%;
        transition: all 0.3s ease;
    }

    .insight-card:hover {
        box-shadow: 0 4px 15px var(--shadow-color);
    }

    .insight-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--border-color);
    }

    /* Mood Grid */
    .mood-grid {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .mood-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        background: rgba(var(--primary-color), 0.05);
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .mood-item:hover {
        background: rgba(var(--primary-color), 0.1);
        transform: translateX(4px);
    }

    .mood-emoji {
        font-size: 1.5rem;
        width: 2.5rem;
        height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 50%;
    }

    .mood-info {
        flex: 1;
    }

    .mood-name {
        font-weight: 600;
        color: var(--text-color);
    }

    .mood-count {
        font-size: 0.85rem;
        color: var(--muted-text);
    }

    .mood-percentage {
        font-weight: 700;
        color: var(--primary-color);
        font-size: 0.9rem;
    }

    /* Activity List */
    .activity-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .activity-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        background: rgba(var(--primary-color), 0.03);
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .activity-item:hover {
        background: rgba(var(--primary-color), 0.08);
    }

    .activity-date {
        font-size: 0.85rem;
        color: var(--muted-text);
        min-width: 3rem;
    }

    .activity-mood {
        font-size: 1.2rem;
        width: 2rem;
        display: flex;
        justify-content: center;
    }

    .activity-title {
        flex: 1;
        color: var(--text-color);
        font-weight: 500;
    }

    /* Pattern Grid */
    .pattern-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 1rem;
    }

    .pattern-item {
        text-align: center;
    }

    .pattern-month {
        font-size: 0.85rem;
        color: var(--muted-text);
        margin-bottom: 0.5rem;
    }

    .pattern-bar {
        height: 8px;
        background: var(--border-color);
        border-radius: 4px;
        margin-bottom: 0.5rem;
        overflow: hidden;
    }

    .pattern-fill {
        height: 100%;
        background: var(--primary-color);
        transition: width 0.8s ease;
    }

    .pattern-count {
        font-weight: 600;
        color: var(--text-color);
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .action-btn {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        color: var(--text-color);
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px var(--shadow-color);
    }

    .action-btn.primary {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .action-btn.secondary {
        background: var(--card-bg);
        color: var(--text-color);
        border-color: var(--border-color);
    }

    .action-icon {
        font-size: 1.2rem;
    }

    .action-text {
        font-weight: 500;
    }

    /* Dark mode specific fixes */
    .dark-mode .metric-icon {
        background: var(--primary-color);
    }

    .dark-mode .mood-item,
    .dark-mode .activity-item {
        background: rgba(74, 158, 255, 0.1);
    }

    .dark-mode .mood-item:hover,
    .dark-mode .activity-item:hover {
        background: rgba(74, 158, 255, 0.15);
    }

    .dark-mode .mood-emoji {
        background: var(--card-bg);
        border-color: var(--border-color);
    }
</style>
